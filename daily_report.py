import os
import json
import time
import requests
import pandas as pd
import yfinance as yf
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from concurrent.futures import ThreadPoolExecutor

# 1. è®€å–ç’°å¢ƒè®Šæ•¸ (GitHub Secrets)
# æ³¨æ„ï¼šé€™è£¡æ”¹ç”¨ os.environï¼Œå› ç‚ºä¸æ˜¯åœ¨ Streamlit ç’°å¢ƒä¸‹åŸ·è¡Œ
EMAIL_SENDER = os.environ.get("EMAIL_SENDER")
EMAIL_PASSWORD = os.environ.get("EMAIL_PASSWORD")
EMAIL_RECEIVER = os.environ.get("EMAIL_RECEIVER", EMAIL_SENDER)

# 2. è¼‰å…¥è³‡æ–™åº«
# ç¢ºä¿ sector_db.json å’Œ stock_names.json éƒ½åœ¨åŒä¸€ç›®éŒ„ä¸‹
try:
    with open("sector_db.json", "r", encoding="utf-8") as f:
        SECTOR_DB = json.load(f)
    with open("stock_names.json", "r", encoding="utf-8") as f:
        STOCK_NAMES = json.load(f)
except:
    print("âŒ è³‡æ–™åº«è®€å–å¤±æ•—")
    SECTOR_DB = {}
    STOCK_NAMES = {}

# 3. æ ¸å¿ƒé‹ç®—å‡½æ•¸ (ç²¾ç°¡ç‰ˆ)
def get_stock_data(ticker):
    try:
        if ticker.isdigit(): ticker = f"{ticker}.TW"
        df = yf.Ticker(ticker).history(period="1y")
        if df.empty: return pd.DataFrame()
        return df
    except: return pd.DataFrame()

def calculate_score(ticker):
    try:
        df = get_stock_data(ticker)
        if df.empty or len(df) < 60: return None
        
        # ç°¡å–®è¨ˆç®—æŒ‡æ¨™ (èˆ‡ä¸»ç¨‹å¼é‚è¼¯ä¸€è‡´)
        close = df['Close']
        ma20 = close.rolling(20).mean()
        ma60 = close.rolling(60).mean()
        vol = df['Volume']
        vol_ma20 = vol.rolling(20).mean()
        
        last = df.iloc[-1]
        score = 0
        
        # æŠ€è¡“
        if last['Close'] > ma20.iloc[-1]: score += 2
        if ma60.iloc[-1] > ma60.iloc[-2]: score += 3 # æ–œç‡å‘ä¸Š
        if last['Close'] > ma60.iloc[-1]: score += 1
        
        # ç±Œç¢¼èˆ‡å‹•èƒ½
        if last['Volume'] > vol_ma20.iloc[-1]: score += 3
        if (last['Close'] - df.iloc[-2]['Close']) > 0: score += 3
        
        return {
            "ä»£è™Ÿ": ticker,
            "åç¨±": STOCK_NAMES.get(ticker, ticker),
            "ç¸½åˆ†": score,
            "ç¾åƒ¹": last['Close']
        }
    except: return None

def send_email(subject, html_content):
    if not EMAIL_SENDER or not EMAIL_PASSWORD:
        print("âŒ æœªè¨­å®š Email Secrets")
        return

    msg = MIMEMultipart()
    msg['From'] = f"AI æˆ°æƒ…å®¤ <{EMAIL_SENDER}>"
    msg['To'] = EMAIL_RECEIVER
    msg['Subject'] = subject
    msg.attach(MIMEText(html_content, 'html'))
    
    try:
        server = smtplib.SMTP_SSL('smtp.gmail.com', 465)
        server.login(EMAIL_SENDER, EMAIL_PASSWORD)
        server.sendmail(EMAIL_SENDER, EMAIL_RECEIVER, msg.as_string())
        server.quit()
        print("âœ… éƒµä»¶ç™¼é€æˆåŠŸ")
    except Exception as e:
        print(f"âŒ ç™¼é€å¤±æ•—: {e}")

# 4. ä¸»åŸ·è¡Œç¨‹åº
def main():
    print("ğŸš€ é–‹å§‹åŸ·è¡Œæ¯æ—¥æ™¨é–“æƒæ...")
    
    # æ”¶é›†æ‰€æœ‰è‚¡ç¥¨
    all_tickers = set()
    for sub in SECTOR_DB.values():
        for t_list in sub.values():
            for t in t_list: all_tickers.add(t)
    
    target_list = list(all_tickers)
    print(f"ğŸ“¡ ç›®æ¨™æ•¸é‡: {len(target_list)} æª”")

    results = []
    # GitHub Runner æ•ˆèƒ½è¼ƒå¼·ï¼Œå¯ä»¥ç”¨ 10 åŸ·è¡Œç·’
    with ThreadPoolExecutor(max_workers=10) as executor:
        futures = list(executor.map(calculate_score, target_list))
        
    for res in futures:
        if res: results.append(res)
        
    if not results:
        print("âŒ ç„¡æƒæçµæœ")
        return

    # æ’åºèˆ‡é¸å‡º Top 10
    res_df = pd.DataFrame(results).sort_values("ç¸½åˆ†", ascending=False)
    top_stock = res_df.iloc[0]
    
    # ç”Ÿæˆ HTML (Top 10)
    top_10_html = ""
    for i in range(min(10, len(res_df))):
        row = res_df.iloc[i]
        icon = "ğŸ”¹"
        if i == 0: icon = "ğŸ¥‡"
        elif i == 1: icon = "ğŸ¥ˆ"
        elif i == 2: icon = "ğŸ¥‰"
        top_10_html += f"<li>{icon} <b>{row['åç¨±']}</b> ({row['ä»£è™Ÿ']}) - ç¸½åˆ†: {row['ç¸½åˆ†']} | ç¾åƒ¹: {row['ç¾åƒ¹']:.1f}</li>"

    email_html = f"""
    <html>
    <body style="font-family: Arial, sans-serif;">
        <h2 style="color: #00adb5;">ğŸ¤– AI æˆ°æƒ…å®¤æ™¨å ± (è‡ªå‹•æ’ç¨‹)</h2>
        <hr>
        <p>GitHub Actions è‡ªå‹•åŸ·è¡Œæƒæå®Œç•¢ï¼ŒTop 10 å¼·å‹¢è‚¡å¦‚ä¸‹ï¼š</p>
        <ul style="line-height: 1.6;">{top_10_html}</ul>
        <br>
        <p style="color: gray;">Generated by GitHub Actions at 06:00 CST</p>
    </body>
    </html>
    """
    
    subject = f"ã€AIæ™¨å ±ã€‘å† è»: {top_stock['åç¨±']} (ç¸½åˆ†:{top_stock['ç¸½åˆ†']})"
    send_email(subject, email_html)

if __name__ == "__main__":
    main()